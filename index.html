<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Srpski_Cas Mini App</title>
  <style>
    .hidden { display: none !important; }
  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&family=Unbounded:wght@600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css?v=20260210-4" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <main class="app">
    <header class="app-bar">
      <div class="app-brand">
        <div class="app-title">Srpski_Cas</div>
        <div class="app-sub">Mini App</div>
      </div>
      <div class="app-progress">
        <span id="sceneLabel">A1 • Сцена 01</span>
        <span id="cardCounter">1/6</span>
      </div>
    </header>

    <div class="status" id="status">Проверяем доступ…</div>

    <section class="panel" id="gate">
      <h1>Тренажёр живой речи</h1>
      <p class="lead">Слушай → повторяй → оценивай. Короткая A1‑сессия.</p>
      <button class="btn primary" id="startBtn" type="button" disabled>Start</button>
      <div class="hint" id="startHint">Нажмите Start, чтобы разрешить автозвук.</div>
    </section>

    <section class="panel hidden" id="trainer">
      <div class="phrase" id="ruText"></div>
      <button class="btn play" id="playBtn" type="button">▶ Слушать</button>
      <button class="btn ghost" id="revealBtn" type="button">Показать ответ</button>
      <div class="answer hidden" id="srText"></div>
      <div class="grades hidden" id="grades">
        <button class="grade hard" data-grade="hard" type="button">Тяжело</button>
        <button class="grade good" data-grade="good" type="button">Хорошо</button>
        <button class="grade easy" data-grade="easy" type="button">Легко</button>
      </div>
    </section>

    <section class="panel hidden" id="blocked">
      <h2>Доступ не подтверждён</h2>
      <p class="lead">Откройте Mini App через кнопку меню в чате бота.</p>
      <button class="btn primary" id="openBotBtn" type="button">Открыть бота</button>
    </section>

    <section class="panel hidden" id="finished">
      <h2>Сессия завершена</h2>
      <p class="lead">Вы прошли <span id="doneCount">0</span> фраз.</p>
      <button class="btn primary" id="restartBtn" type="button">Ещё раз</button>
    </section>
  </main>

  <script>
    const API_BASE = 'https://api.intelahost.org';
    const statusEl = document.getElementById('status');
    const gate = document.getElementById('gate');
    const trainer = document.getElementById('trainer');
    const blocked = document.getElementById('blocked');
    const finished = document.getElementById('finished');
    const startBtn = document.getElementById('startBtn');
    const startHint = document.getElementById('startHint');
    const openBotBtn = document.getElementById('openBotBtn');
    const restartBtn = document.getElementById('restartBtn');
    const revealBtn = document.getElementById('revealBtn');
    const ruText = document.getElementById('ruText');
    const srText = document.getElementById('srText');
    const cardCounter = document.getElementById('cardCounter');
    const sceneLabel = document.getElementById('sceneLabel');
    const playBtn = document.getElementById('playBtn');
    const doneCount = document.getElementById('doneCount');
    const grades = document.getElementById('grades');
    const gradeButtons = Array.from(document.querySelectorAll('.grade'));

    const tg = window.Telegram && window.Telegram.WebApp;

    const deck = [
      { ru: 'Привет! Как дела?', sr: 'Zdravo! Kako si?' },
      { ru: 'Я из России.', sr: 'Ja sam iz Rusije.' },
      { ru: 'Где находится вокзал?', sr: 'Gde je železnička stanica?' },
      { ru: 'Мне нужна помощь.', sr: 'Treba mi pomoć.' },
      { ru: 'Сколько это стоит?', sr: 'Koliko to košta?' },
      { ru: 'Спасибо! Пока.', sr: 'Hvala! Ćao.' },
    ];

    const state = {
      accessOk: false,
      index: 0,
      revealed: false,
      started: false,
    };

    function show(el) {
      el.classList.remove('hidden');
    }

    function hide(el) {
      el.classList.add('hidden');
    }

    function setStatus(text) {
      statusEl.textContent = text;
    }

    function setAccess(ok, message) {
      state.accessOk = ok;
      if (message) {
        setStatus(message);
      }
      if (ok) {
        startBtn.disabled = false;
        show(gate);
        hide(blocked);
      } else {
        startBtn.disabled = true;
        hide(trainer);
        hide(finished);
        hide(gate);
        show(blocked);
      }
    }

    function setGradesEnabled(enabled) {
      gradeButtons.forEach((btn) => {
        btn.disabled = !enabled;
      });
      grades.classList.toggle('hidden', !enabled);
    }

    function renderCard() {
      const item = deck[state.index];
      if (!item) {
        showFinished();
        return;
      }
      ruText.textContent = item.ru;
      srText.textContent = item.sr;
      sceneLabel.textContent = 'A1 • Сцена 01';
      cardCounter.textContent = `${state.index + 1}/${deck.length}`;
      srText.classList.toggle('hidden', !state.revealed);
      revealBtn.textContent = state.revealed ? 'Скрыть ответ' : 'Показать ответ';
      setGradesEnabled(state.revealed);
    }

    function showFinished() {
      doneCount.textContent = `${deck.length}`;
      hide(trainer);
      show(finished);
    }

    function advanceCard() {
      const nextIndex = Math.min(state.index + 1, deck.length);
      state.index = nextIndex;
      state.revealed = false;
      renderCard();
      playAudio();
    }

    function playAudio() {
      if (!state.started) {
        return;
      }
      if (tg && tg.HapticFeedback) {
        tg.HapticFeedback.impactOccurred('light');
      }
      try {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) {
          return;
        }
        const ctx = new AudioContext();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.value = 520;
        gain.gain.value = 0.05;
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start();
        osc.stop(ctx.currentTime + 0.18);
      } catch (err) {
        // ignore
      }
    }

    function startSession() {
      state.started = true;
      state.index = 0;
      state.revealed = false;
      hide(gate);
      hide(finished);
      show(trainer);
      renderCard();
      playAudio();
    }

    startBtn.addEventListener('click', () => {
      if (!state.accessOk) {
        return;
      }
      if (tg && tg.ready) {
        tg.ready();
      }
      startSession();
    });

    revealBtn.addEventListener('click', () => {
      state.revealed = !state.revealed;
      renderCard();
    });

    gradeButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        if (!state.revealed) {
          return;
        }
        advanceCard();
      });
    });

    playBtn.addEventListener('click', () => {
      playAudio();
    });

    restartBtn.addEventListener('click', () => {
      startSession();
    });

    openBotBtn.addEventListener('click', () => {
      const url = 'https://t.me/SrpskiCas_bot';
      if (tg && tg.openTelegramLink) {
        tg.openTelegramLink(url);
      } else {
        window.location.href = url;
      }
    });

    function getInitData() {
      if (tg && tg.initData) {
        return tg.initData;
      }
      const hash = window.location.hash.startsWith('#') ? window.location.hash.slice(1) : '';
      const search = window.location.search.startsWith('?') ? window.location.search.slice(1) : '';
      const params = new URLSearchParams(hash || search);
      const raw = params.get('tgWebAppData') || '';
      return raw ? decodeURIComponent(raw) : '';
    }

    const initData = getInitData();

    if (tg && tg.ready) {
      tg.ready();
    }

    if (!initData) {
      setAccess(false, 'Откройте Mini App через кнопку меню в Telegram');
    } else {
      setStatus('Проверяем доступ…');
      fetch(`${API_BASE}/access?initData=${encodeURIComponent(initData)}`)
        .then(async (r) => {
          const data = await r.json().catch(() => ({}));
          if (!r.ok || !data || !data.ok) {
            const reason = data && data.detail ? data.detail : 'Доступ не подтверждён';
            throw new Error(reason);
          }
          setAccess(true, 'Доступ подтверждён');
        })
        .catch((err) => {
          setAccess(false, `Доступ не подтверждён: ${err.message}`);
        });
    }
  </script>
</body>
</html>
