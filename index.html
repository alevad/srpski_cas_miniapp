<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Srpski_Cas Mini App</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <main class="app">
    <h1>Srpski_Cas Mini App</h1>
    <p>Минимальная стартовая страница для Mini App.</p>
    <div class="card">
      <div class="label">Статус</div>
      <div id="status">Ожидание запуска в Telegram…</div>
    </div>
    <details class="card">
      <summary class="label">Диагностика</summary>
      <pre id="debug">Ожидание…</pre>
    </details>
    <a class="btn" href="https://t.me/SrpskiCas_bot">Открыть бота</a>
  </main>

  <script>
    const API_BASE = 'https://api.intelahost.org';
    const status = document.getElementById('status');
    const debug = document.getElementById('debug');
    const tg = window.Telegram && window.Telegram.WebApp;

    function getInitData() {
      if (tg && tg.initData) {
        return tg.initData;
      }
      const hash = window.location.hash.startsWith('#') ? window.location.hash.slice(1) : '';
      const search = window.location.search.startsWith('?') ? window.location.search.slice(1) : '';
      const params = new URLSearchParams(hash || search);
      const raw = params.get('tgWebAppData') || '';
      return raw ? decodeURIComponent(raw) : '';
    }

    function setDebug(info) {
      debug.textContent = JSON.stringify(info, null, 2);
    }

    const initData = getInitData();
    const hash = window.location.hash.startsWith('#') ? window.location.hash.slice(1) : '';
    const search = window.location.search.startsWith('?') ? window.location.search.slice(1) : '';
    const params = new URLSearchParams(hash || search);
    const tgWebAppDataRaw = params.get('tgWebAppData') || '';
    const initDataPreview = initData
      ? `${initData.slice(0, 16)}...${initData.slice(-8)}`
      : '';

    setDebug({
      href: window.location.href,
      hasTelegram: Boolean(window.Telegram),
      hasWebApp: Boolean(tg),
      tgInitDataLen: tg && tg.initData ? tg.initData.length : 0,
      tgWebAppDataLen: tgWebAppDataRaw.length,
      initDataLen: initData.length,
      initDataPreview,
      platform: tg ? tg.platform : '',
      version: tg ? tg.version : '',
    });

    if (tg) {
      tg.ready();
      status.textContent = 'Mini App открыт через Telegram WebApp';
    } else if (initData) {
      status.textContent = 'Mini App открыт через Telegram (initData из URL)';
    } else {
      status.textContent = 'Откройте страницу из Telegram WebApp';
    }

    if (initData) {
      fetch(`${API_BASE}/access?initData=${encodeURIComponent(initData)}`)
        .then((r) => r.json())
        .then((data) => {
          if (data && data.ok) {
            status.textContent = 'Доступ подтверждён';
          } else {
            status.textContent = `Ответ backend: ${JSON.stringify(data)}`;
          }
        })
        .catch((err) => {
          status.textContent = `Ошибка запроса: ${err}`;
        });
    } else if (tg) {
      status.textContent = 'initData отсутствует (открыто не из WebApp)';
    }
  </script>
</body>
</html>
