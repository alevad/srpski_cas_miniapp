<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Srpski_Cas Mini App</title>
  <style>
    .hidden { display: none !important; }
  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css?v=20260210-10" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <main class="app">
    <header class="app-bar">
      <div class="app-brand">
        <img class="brand-logo" src="assets/logo.png" alt="Srpski_Cas" />
      </div>
    </header>

    <div class="progress" id="progress">
      <span id="sceneLabel">A1 вЂў РЎС†РµРЅР° 01</span>
      <span id="cardCounter">1/6</span>
    </div>

    <section class="panel" id="gate">
      <h1>РўСЂРµРЅР°Р¶С‘СЂ Р¶РёРІРѕР№ СЂРµС‡Рё</h1>
      <p class="lead">РЎР»СѓС€Р°Р№ в†’ РїРѕРІС‚РѕСЂСЏР№ в†’ РѕС†РµРЅРёРІР°Р№. РљРѕСЂРѕС‚РєР°СЏ A1вЂ‘СЃРµСЃСЃРёСЏ.</p>
      <button class="btn primary" id="startBtn" type="button" disabled>Start</button>
      <div class="hint" id="startHint">РќР°Р¶РјРёС‚Рµ Start, С‡С‚РѕР±С‹ СЂР°Р·СЂРµС€РёС‚СЊ Р°РІС‚РѕР·РІСѓРє.</div>
    </section>

    <section class="panel hidden" id="trainer">
      <div class="phrase" id="ruText"></div>
      <button class="btn play" id="playBtn" type="button">в–¶ РЎР»СѓС€Р°С‚СЊ</button>
      <button class="btn ghost" id="revealBtn" type="button">РџРѕРєР°Р·Р°С‚СЊ РѕС‚РІРµС‚</button>
      <div class="answer hidden" id="srText"></div>
      <div class="grades hidden" id="grades">
        <button class="grade hard" data-grade="hard" type="button">РўСЏР¶РµР»Рѕ</button>
        <button class="grade good" data-grade="good" type="button">РҐРѕСЂРѕС€Рѕ</button>
        <button class="grade easy" data-grade="easy" type="button">Р›РµРіРєРѕ</button>
      </div>
    </section>

    <section class="panel hidden" id="blocked">
      <h2>Р”РѕСЃС‚СѓРї РЅРµ РїРѕРґС‚РІРµСЂР¶РґС‘РЅ</h2>
      <p class="lead">РћС‚РєСЂРѕР№С‚Рµ Mini App С‡РµСЂРµР· РєРЅРѕРїРєСѓ РјРµРЅСЋ РІ С‡Р°С‚Рµ Р±РѕС‚Р°.</p>
      <button class="btn primary" id="openBotBtn" type="button">РћС‚РєСЂС‹С‚СЊ Р±РѕС‚Р°</button>
    </section>

    <section class="panel hidden" id="finished">
      <h2>РЎРµСЃСЃРёСЏ Р·Р°РІРµСЂС€РµРЅР°</h2>
      <p class="lead">Р’С‹ РїСЂРѕС€Р»Рё <span id="doneCount">0</span> С„СЂР°Р·.</p>
      <button class="btn primary" id="restartBtn" type="button">Р•С‰С‘ СЂР°Р·</button>
    </section>
  </main>

  <script>
    const API_BASE = 'https://api.intelahost.org';
    const gate = document.getElementById('gate');
    const trainer = document.getElementById('trainer');
    const blocked = document.getElementById('blocked');
    const finished = document.getElementById('finished');
    const startBtn = document.getElementById('startBtn');
    const startHint = document.getElementById('startHint');
    const openBotBtn = document.getElementById('openBotBtn');
    const restartBtn = document.getElementById('restartBtn');
    const revealBtn = document.getElementById('revealBtn');
    const ruText = document.getElementById('ruText');
    const srText = document.getElementById('srText');
    const cardCounter = document.getElementById('cardCounter');
    const sceneLabel = document.getElementById('sceneLabel');
    const playBtn = document.getElementById('playBtn');
    const doneCount = document.getElementById('doneCount');
    const grades = document.getElementById('grades');
    const gradeButtons = Array.from(document.querySelectorAll('.grade'));

    const tg = window.Telegram && window.Telegram.WebApp;
    const STORAGE_KEY = 'sc_miniapp_state_v1';
    const DATA_URL = 'data/restaurant_ordering.json?v=20260210-1';
    const SCENE_TITLE = 'restaurant_ordering';
    const AUDIO_BASE = 'audio/restaurant_ordering';
    const audioPlayer = new Audio();

    let deck = [];

    const state = {
      accessOk: false,
      index: 0,
      revealed: false,
      started: false,
      audioUrl: '',
      deckReady: false,
    };

    function show(el) {
      el.classList.remove('hidden');
    }

    function hide(el) {
      el.classList.add('hidden');
    }

    function setAccess(ok, message) {
      state.accessOk = ok;
      if (ok) {
        startBtn.disabled = false;
        show(gate);
        hide(blocked);
      } else {
        startBtn.disabled = true;
        hide(trainer);
        hide(finished);
        hide(gate);
        show(blocked);
      }
      if (message && !ok) {
        startHint.textContent = message;
      }
    }

    function setGradesEnabled(enabled) {
      gradeButtons.forEach((btn) => {
        btn.disabled = !enabled;
      });
      grades.classList.toggle('hidden', !enabled);
    }

    function renderCard() {
      if (!deck.length) {
        ruText.textContent = 'РљРѕРЅС‚РµРЅС‚ Р·Р°РіСЂСѓР¶Р°РµС‚СЃСЏвЂ¦';
        srText.textContent = '';
        playBtn.disabled = true;
        setGradesEnabled(false);
        return;
      }
      const item = deck[state.index];
      if (!item) {
        showFinished();
        return;
      }
      ruText.textContent = item.ru;
      srText.textContent = item.sr;
      sceneLabel.textContent = `A1 вЂў ${SCENE_TITLE}`;
      cardCounter.textContent = `${state.index + 1}/${deck.length}`;
      srText.classList.toggle('hidden', !state.revealed);
      revealBtn.textContent = state.revealed ? 'РЎРєСЂС‹С‚СЊ РѕС‚РІРµС‚' : 'РџРѕРєР°Р·Р°С‚СЊ РѕС‚РІРµС‚';
      state.audioUrl = resolveAudioUrl(item);
      playBtn.disabled = !state.audioUrl;
      setGradesEnabled(state.revealed);
      saveState();
    }

    function showFinished() {
      doneCount.textContent = `${deck.length}`;
      hide(trainer);
      show(finished);
      saveState();
    }

    function advanceCard() {
      const nextIndex = Math.min(state.index + 1, deck.length);
      state.index = nextIndex;
      state.revealed = false;
      renderCard();
      playAudio();
    }

    function playAudio() {
      if (!state.started) {
        return;
      }
      if (!state.audioUrl) {
        return;
      }
      if (tg && tg.HapticFeedback) {
        tg.HapticFeedback.impactOccurred('light');
      }
      audioPlayer.pause();
      audioPlayer.src = state.audioUrl;
      audioPlayer.currentTime = 0;
      audioPlayer.play().catch(() => {
        // ignore
      });
    }

    function startSession(reset) {
      state.started = true;
      if (reset) {
        state.index = 0;
      }
      state.revealed = false;
      hide(gate);
      hide(finished);
      if (state.index >= deck.length) {
        showFinished();
        return;
      }
      show(trainer);
      renderCard();
      playAudio();
    }

    startBtn.addEventListener('click', () => {
      if (!state.accessOk) {
        return;
      }
      if (tg && tg.ready) {
        tg.ready();
      }
      startSession(false);
    });

    revealBtn.addEventListener('click', () => {
      state.revealed = !state.revealed;
      renderCard();
    });

    gradeButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        if (!state.revealed) {
          return;
        }
        advanceCard();
      });
    });

    playBtn.addEventListener('click', () => {
      playAudio();
    });

    restartBtn.addEventListener('click', () => {
      startSession(true);
    });

    openBotBtn.addEventListener('click', () => {
      const url = 'https://t.me/SrpskiCas_bot';
      if (tg && tg.openTelegramLink) {
        tg.openTelegramLink(url);
      } else {
        window.location.href = url;
      }
    });

    function getInitData() {
      if (tg && tg.initData) {
        return tg.initData;
      }
      const hash = window.location.hash.startsWith('#') ? window.location.hash.slice(1) : '';
      const search = window.location.search.startsWith('?') ? window.location.search.slice(1) : '';
      const params = new URLSearchParams(hash || search);
      const raw = params.get('tgWebAppData') || '';
      return raw ? decodeURIComponent(raw) : '';
    }

    const initData = getInitData();

    if (tg && tg.ready) {
      tg.ready();
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          return;
        }
        const saved = JSON.parse(raw);
        if (Number.isInteger(saved.index)) {
          state.index = Math.min(Math.max(saved.index, 0), deck.length);
        }
      } catch (err) {
        // ignore
      }
    }

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ index: state.index }));
      } catch (err) {
        // ignore
      }
    }

    function resolveAudioUrl(item) {
      if (!AUDIO_BASE || !item || !item.audio) {
        return '';
      }
      return `${AUDIO_BASE}/${item.audio}`;
    }

    async function loadDeck() {
      try {
        const res = await fetch(DATA_URL);
        if (!res.ok) {
          throw new Error(`deck load failed: ${res.status}`);
        }
        const data = await res.json();
        deck = data
          .map((item) => ({
            id: item.id,
            ru: item.ru_text,
            sr: item.sr_text,
            audio: item.audio_sr_file,
          }))
          .filter((item) => item.ru && item.sr)
          .slice(0, 100);
        state.deckReady = deck.length > 0;
      } catch (err) {
        deck = [];
        state.deckReady = false;
      }
      if (state.index >= deck.length) {
        state.index = 0;
      }
      if (state.accessOk && state.deckReady) {
        startBtn.disabled = false;
      }
      renderCard();
    }

    loadState();
    loadDeck();

    if (!initData) {
      setAccess(false, 'РћС‚РєСЂРѕР№С‚Рµ Mini App С‡РµСЂРµР· РєРЅРѕРїРєСѓ РјРµРЅСЋ РІ Telegram');
    } else {
      fetch(`${API_BASE}/access?initData=${encodeURIComponent(initData)}`)
        .then(async (r) => {
          const data = await r.json().catch(() => ({}));
          if (!r.ok || !data || !data.ok) {
            const reason = data && data.detail ? data.detail : 'Р”РѕСЃС‚СѓРї РЅРµ РїРѕРґС‚РІРµСЂР¶РґС‘РЅ';
            throw new Error(reason);
          }
          setAccess(true);
          if (state.deckReady) {
            startBtn.disabled = false;
          }
        })
        .catch((err) => {
          setAccess(false, `Р”РѕСЃС‚СѓРї РЅРµ РїРѕРґС‚РІРµСЂР¶РґС‘РЅ: ${err.message}`);
        });
    }
  </script>
</body>
</html>
